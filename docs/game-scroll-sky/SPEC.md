# 横スクロールシューティング仕様書

## 基本情報
- **対象リポジトリ**: `/Users/takeda-akihito/works/Game/scroll_shooting`
- **主要ファイル**: `index.html`, `main.js`
- **ゲーム状態**: `"loading" → "ready" → "running" → "gameover"` の4段階。スペースキーまたはクリック/タップで開始・再スタート可能。`"gameover"` への遷移ロジックは未実装。

## ループと共通処理
- `requestAnimationFrame` でゲームループを構成し、1フレームのΔtを最大0.05秒に制限。
- 毎フレーム `updateGame` → `drawGame` の順で処理。
- スコアは6桁ゼロ埋めで表示。攻撃レベルは `ATTACK: 現在値 / 16` として HUD に表示し、ボス出現中は残り時間を秒単位でカウントダウン表示する。
- 背景は速度90px/秒で右から左へループ描画。
- キーボード (WASD/矢印) とポインタ (マウス/タッチ) を併用でき、ポインタ操作時はスムージング追従。

## プレイヤー機
- 初期位置は左側 (x=120)、サイズは 84×72。移動速度は260px/秒。
- 体当たりが唯一の攻撃手段。攻撃力は現在のパワーレベルに等しく、命中後0.28秒のクールダウンを持つ。
- 移動方向に応じて機体の向きを補間回転 (最後の移動ベクトルを継続使用)。
- `powerLevel` は1〜16で管理（初期値は1）。親機のみでレベル1、以降はレベルが1上がるごとに支援機が1機追加され、最大で支援機15機（レベル16）を展開できる。被弾や支援機破壊で最低1まで減少。増加/減少時に支援機の数を再構成。
- 被弾処理 `handlePlayerHit`: パワーレベルを1段階下降、96px規模の爆発演出、1.2秒の無敵、攻撃クールダウン解除。
- 支援機はパワーレベルが上がるごとに1機ずつ解放され、最大15機まで所持可能。攻撃レベルが上限値に達した後も、子機が15機未満であればパワーアップ取得ごとに1機ずつ追加される。各支援機は前方のリーダー（親機または直前の子機）にバネで接続されたように追従し、一定距離を保ちながら少し遅れて移動する。パワーアップ取得時も既存の支援機配置は維持され、新たに追加された支援機のみ陣形に組み込まれる。支援機が破壊された場合も残存機の編隊は崩さず、必要最小限の再接続のみを行う。

## 支援機と耐久仕様
- 支援機は敵機・敵弾と個別に当たり判定を持ち、最大8ヒット分の耐久を持つ。
- バネ挙動はスプリング+減衰モデルで実装され、リーダーからの距離が伸び縮みすると速度ベクトルが発生し、緩やかにリーダーの向きへ姿勢を合わせる。
- 被弾ごとに耐久を1消費し、残耐久が0になるとその支援機のみ破壊され、同時にプレイヤーのパワーレベルが1低下する。
- 被弾中の支援機は短時間だけ色反転し、ダメージフィードバックを伝える。
- 敵機と接触した支援機は同時に敵へ1ダメージを与える（ボス含む）。
- 被弾時は爆発エフェクトを生成し、敵機との接触時は敵を60px押し戻して再衝突を防ぐ。
- プレイヤーが無敵状態の場合は支援機の耐久は減少せず、弾のみ消滅する。
- 陣形は最大3列（左・中央・右）を繰り返すグリッドで構成され、先頭列は左右に広がり後続列は縦方向に整列する。

## 敵キャラクター
- 敵タイプ: `grunt` (HP1, 得点120, ドロップ率32%, 射撃なし)、`midBoss` (HP5, 得点620, ドロップ率45%, 2.4秒間隔で水平弾)、`boss` (HP20, 得点3200, ドロップ率100%, 1.7秒間隔で狙い撃ち＋拡散弾)。
- 移動: いずれも右→左へ進行。`grunt` は小刻みな縦揺れ、`midBoss` は大きなサイン波で上下移動、`boss` は画面内に収まるまでは緩やかに前進し、完全に見えた後はその場で上下移動を続ける。
- スポーン:
  - `grunt`: 経過時間に応じた間隔 (初期2.1秒→下限0.9秒) で常時出現。
  - `midBoss`: 約10〜16秒間隔で最大1体。撃破済みでないと新規出現しない。
  - `boss`: 出撃から20秒経過後に初出現し、同時に1体まで。出現後60秒以内に撃破できないと時間切れでゲームオーバーになる。ボスは画面内に収まった後は横移動を停止し、その場で上下移動を続け、ノックバックでは位置が動かない。
- HPが0以下で撃破。得点加算後、敵サイズに応じた爆発とドロップ抽選を行う。
- ボスを撃破するとゲームクリアとなり、勝利メッセージを表示する。

## 敵弾
- `midBoss`: 左向き直進弾 (速度260px/秒) を1発発射。
- `boss`: 自機狙い弾 (速度300px/秒、最大60%を左向きに補正) と上下に60pxずらした拡散弾2発。
- 敵弾は各フレームで当たり判定をチェックし、支援機またはプレイヤーに命中すると消滅。

## パワーアップ
- 拾得アイテムは攻撃力上昇 (`powerLevel` +1)。攻撃レベルが上限 (`powerLevel = 16`) に達した状態でも、子機が最大15機に届くまでは取得ごとに支援機を1機追加する。攻撃・子機がともに上限に達している場合はスコア +200 点のみ。
- 右端外から速度180px/秒で左移動し、正弦波で上下振動。
- ドロップ: 敵撃破時にドロップ率判定。外部タイマーでも8〜14秒間隔で単独出現。

## 衝突・被弾判定
- 判定は矩形を使用 (`rectsOverlap`)。
- プレイヤーと敵が接触すると、攻撃クールダウンが空のときのみ敵へダメージ。敵を倒せなかった場合も爆発演出が起きるが、プレイヤーのパワー減少は発生しない。
- 敵は被弾時に一瞬色反転し、ダメージを受けたことを視覚的に示す。
- 被弾後のプレイヤーは即座にわずかに後退し、減衰するノックバック速度で段階的に押し戻される。

## オーバーレイ表示
- `setOverlay`/`hideOverlay` で状態を切り替える。読み込み中・準備完了・ゲームオーバーメッセージを表示。
- ゲーム開始時 `resetGame` で全タイマーと配列を初期化し、プレイヤーをリセット。
- `triggerGameOver` は定義済みだが未使用のため、実際にはゲームオーバーへ遷移しない。

## 未実装・留意点
- プレイヤーが `powerLevel = 1` の状態でもゲーム続行。残機やライフの概念は存在しない。
